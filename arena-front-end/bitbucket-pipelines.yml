image: node:20.18.0

pipelines:
  default:
    - step:
        name: Build
        caches:
          - node
        script:
          - echo "ðŸ”¹ Criando .env de production..."
          - echo "NEXT_PUBLIC_API_BASE_URL=$URL_DNS" > .env.production
          - echo "âœ… .env.production criado"
          
          - echo "ðŸ”¹ Iniciando build..."
          - npm ci
          - echo "âœ… DependÃªncias instaladas"
          - npm run lint
          - echo "âœ… Lint ok"
          - npm run build
          - echo "âœ… Build concluÃ­do"
        artifacts:
          - .next/**
          - build/**
          - public/**
          - package.json
          - package-lock.json

    - step:
        name: Deploy to AWS EC2
        deployment: production
        script:
          # Instala rsync e ssh-client
          - echo "ðŸ”¹ Instalando rsync e ssh-client..."
          - apt-get update && apt-get install -y rsync openssh-client
          - echo "âœ… Pacotes instalados"

          # Adiciona fingerprint da EC2 no known_hosts
          - mkdir -p ~/.ssh
          - echo "ðŸ”¹ Registrando EC2 no known_hosts..."
          - ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts
          - echo "âœ… known_hosts atualizado"

          # Teste de conexÃ£o SSH
          - echo "ðŸ”¹ Testando conexÃ£o SSH com EC2..."
          - ssh -o BatchMode=yes ubuntu@$EC2_HOST "echo 'âœ… ConexÃ£o SSH OK!'"

          # Envia arquivos buildados para a EC2 via rsync
          - echo "ðŸ”¹ Enviando arquivos para EC2 via rsync..."
          - rsync -avz --delete --exclude=node_modules --exclude=.git ./ ubuntu@$EC2_HOST:/home/ubuntu/arena-front-end/
          - echo "âœ… Arquivos enviados"

          # Executa comandos remotos na EC2
          - echo "ðŸ”¹ Executando comandos na EC2..."
          - ssh ubuntu@$EC2_HOST "
              echo 'ðŸ”¹ Entrou na EC2'
              cd ~/arena-front-end &&
              echo 'ðŸ”¹ DiretÃ³rio arena-front-end'
              npm ci --only=production &&
              echo 'âœ… DependÃªncias de produÃ§Ã£o instaladas'
              pm2 restart arena-front-end || pm2 start npm --name arena-front-end -- start &&
              echo 'âœ… PM2 atualizado'
            "

